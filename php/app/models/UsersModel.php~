<?php

class UsersModel
{
    private $table = 'users';
    private $db;


    public function __construct()
    {
        $this->db = new Database;
    }

    // Cek apakah ada user dalam tabel
    public function checkUserExists()
    {
        $this->db->query('EXEC sp_CheckUserExists');
        $result = $this->db->single();
        return $result['user_count'] > 0;
    }

    // Fungsi untuk menambahkan user default
    public function addDefaultUser()
    {
        $defaultData = [
            'name' => 'admin',
            'username' => 'admin',
            'email' => 'admin@example.com',
            'profile_picture' => NULL,
            'password' => password_hash('123', PASSWORD_BCRYPT), // Hash password default
            'role_id' => 1
        ];

        $this->db->query('EXEC sp_AddDefaultUser :name, :username, :email, :profile_picture, :password, :role_id');
        $this->db->bind(':name', $defaultData['name']);
        $this->db->bind(':username', $defaultData['username']);
        $this->db->bind(':email', $defaultData['email']);
        $this->db->bind(':profile_picture', $defaultData['profile_picture']);
        $this->db->bind(':password', $defaultData['password']);
        $this->db->bind(':role_id', $defaultData['role_id']);
        $this->db->execute();
    }

    // fungsi mengambil seluruh data user
    public function getUser()
    {
        $this->db->query('EXEC sp_GetUsers');
        return $this->db->resultSet();
    }

    public function getUserByRole($role)
    {
        $this->db->query('EXEC sp_GetUsersByRole :role_id');
        $this->db->bind(':role_id', $role);
        return $this->db->resultSet();
    }

    // fungsi menambah user
//CREATE PROCEDURE AddUser
//@name NVARCHAR(100),
//@username NVARCHAR(100),
//@password NVARCHAR(255),
//@profile_picture NVARCHAR(255),
//@role_id INT,
//@user_email NVARCHAR(255)
//AS
//BEGIN
//SET NOCOUNT ON;
//
//INSERT INTO users (name, username, password, email, profile_picture, role_id)
//VALUES (@name, @username, @password, @user_email, @profile_picture, @role_id);
//END;
    public function addUser($email, $data, $photo)
    {
        $this->db->query('EXEC AddUser @name = :name, @username = :username, @password = :password, 
                                @profile_picture = :profile_picture, @role_id = :role_id, @user_email = :email');

        $this->db->bind('name', $data['name']);
        $this->db->bind('username', $data['username']);
        $this->db->bind('password', password_hash($data['password'], PASSWORD_BCRYPT));
        $this->db->bind('email', $email);
        $this->db->bind('profile_picture', $photo);
        $this->db->bind('role_id', $data['role']);
        try {
            $this->db->execute();
            return $this->db->rowCount();
        } catch (PDOException $e) {
            error_log('Database Error: ' . $e->getMessage());
            return false;
        }
    }


    //fungsi mencari user berdasarkan username
    public function getUserByUsername($username)
    {
        $this->db->query('EXEC sp_GetUserByUsername @username = :username');
        $this->db->bind(':username', $username);
        return $this->db->single();
    }

    //fungsi mencari user berdasarkan id
    public function getUserById($id)
    {
        $this->db->query('EXEC sp_GetUserById @user_id = :user_id');
        $this->db->bind(':user_id', $id);
        return $this->db->single();
    }

    //fungsi menghapus img di files profile
    public function deleteImage($id)
    {
        $this->db->query('EXEC sp_GetProfilePicture @user_id = :user_id');
        $this->db->bind(':user_id', $id);
        return $this->db->single();
    }


    //fungsi menghapus user
    public function deleteUser($id)
    {
        $this->db->query('EXEC sp_DeleteUser :user_id');
        $this->db->bind(':user_id', $id);
        $this->db->execute();
        return $this->db->rowCount();
    }


    //fungsi mengedit user
    public function editUser($email, $id, $data, $photo, $password)
    {
        $this->db->query('EXEC sp_EditUser :user_id, :name, :username, :email, :profile_picture, :password, :role_id');
        $this->db->bind(':user_id', $id);
        $this->db->bind(':name', $data['name']);
        $this->db->bind(':username', $data['username']);
        $this->db->bind(':email', $email);
        $this->db->bind(':profile_picture', $photo);
        $this->db->bind(':password', $password);
        $this->db->bind(':role_id', $data['role_id']);
        $this->db->execute();

        return $this->db->rowCount();
    }

    public function isEmailExists($email, $userId = null)
    {
        $query = "SELECT * FROM users WHERE email = :email AND user_id != :user_id";
        $this->db->query($query);
        $this->db->bind('email', $email);
        $this->db->bind('user_id', $userId);
        return $this->db->single() ? true : false;
    }

    public function isUsernameExists($username, $userId = null)
    {
        $query = "SELECT * FROM users WHERE username = :username AND user_id != :user_id";
        $this->db->query($query);
        $this->db->bind('username', $username);
        $this->db->bind('user_id', $userId);
        return $this->db->single() ? true : false;
    }

}