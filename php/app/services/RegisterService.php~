<?php

namespace app\services;

class RegisterService
{
    private \mysqli $connection;
    private string $table = 'users';

    public function __construct($db)
    {
        $this->connection = $db;
    }

    public function addUser(string $username, string $email, string $password, int $role_id = 2): bool
    {
        $hashed_password = password_hash($password, PASSWORD_DEFAULT);
        $stmt = $this->connection->prepare("INSERT INTO {$this->table} (username, email, password, role_id) VALUES (?, ?, ?, ?)");

        if ($stmt) {
            $stmt->bind_param("sssi", $username, $email, $hashed_password, $role_id);
            return $stmt->execute();
        }
        return false;
    }

    public function getAllUsers(): array
    {
        $stmt = $this->connection->prepare("SELECT user_id, username, email, role_id FROM {$this->table}");
        $stmt->execute();
        return $stmt->get_result()->fetch_all(MYSQLI_ASSOC);
    }

    public function getUserById(int $user_id): ?array
    {
        $stmt = $this->connection->prepare("SELECT * FROM {$this->table} WHERE user_id = ?");
        $stmt->bind_param("i", $user_id);
        $stmt->execute();
        return $stmt->get_result()->fetch_assoc() ?: null;
    }

    public function updateUser(int $user_id, string $username, string $email, int $role_id): bool
    {
        $stmt = $this->connection->prepare("UPDATE {$this->table} SET username = ?, email = ?, role_id = ? WHERE user_id = ?");
        $stmt->bind_param("ssii", $username, $email, $role_id, $user_id);
        return $stmt->execute();
    }

    public function deleteUser(int $user_id): bool
    {
        $stmt = $this->connection->prepare("DELETE FROM {$this->table} WHERE user_id = ?");
        $stmt->bind_param("i", $user_id);
        return $stmt->execute();
    }
}
